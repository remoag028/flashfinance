<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Finance News & Summary</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Set up configuration for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-gray': '#f3f4f6',
                        'accent-yellow': '#fcd34d',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for Inter font and general aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* secondary-gray */
        }
        /* Style for the loading spinner */
        .spinner {
            border-top-color: #1e40af; /* primary-blue */
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom scrollbar for content area */
        #content-area {
            max-height: 75vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on mobile */
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">
                <span class="text-primary-blue">Daily</span> Market Monitor
            </h1>
            <p class="text-gray-500 mt-1">Real-time finance news and concise AI summaries.</p>
        </header>

        <!-- Control Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <button id="fetchNewsBtn"
                class="w-full sm:w-1/2 flex items-center justify-center bg-primary-blue hover:bg-blue-800 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-primary-blue focus:ring-opacity-50 disabled:bg-gray-400">
                <svg id="fetchIcon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <span id="fetchText">Get Today's Top News (Real-Time)</span>
                <div id="fetchLoader" class="spinner w-5 h-5 border-2 border-transparent rounded-full ml-2 hidden"></div>
            </button>

            <button id="summarizeBtn" disabled
                class="w-full sm:w-1/2 flex items-center justify-center bg-accent-yellow hover:bg-yellow-500 text-gray-800 font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-accent-yellow focus:ring-opacity-50 disabled:bg-gray-300 disabled:text-gray-600">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span id="summarizeText">Summarize (60 Words Max)</span>
                <div id="summarizeLoader" class="spinner w-5 h-5 border-2 border-transparent rounded-full ml-2 hidden"></div>
            </button>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="bg-secondary-gray p-4 md:p-6 rounded-lg border border-gray-200 text-gray-700">
            <p id="initial-message" class="text-center text-gray-500 italic">
                Click "Get Today's Top News (Real-Time)" to fetch the latest finance and market stories using real-time search.
            </p>
            <div id="news-content" class="prose max-w-none hidden">
                <!-- News content will be injected here -->
            </div>
            <div id="citation-container" class="mt-4 pt-4 border-t border-gray-300 hidden">
                <h3 class="text-sm font-semibold text-primary-blue mb-2">Sources</h3>
                <ul id="sources-list" class="text-xs space-y-1 text-gray-600">
                    <!-- Sources will be injected here -->
                </ul>
            </div>
        </div>
        
    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global configuration variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- Netlify Function Endpoint ---
        // This is the secure proxy we call instead of the external Gemini API
        const NETLIFY_FUNCTION_URL = '/.netlify/functions/get-news';

        // UI Elements
        const fetchNewsBtn = document.getElementById('fetchNewsBtn');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const newsContentDiv = document.getElementById('news-content');
        const initialMessage = document.getElementById('initial-message');
        const fetchLoader = document.getElementById('fetchLoader');
        const summarizeLoader = document.getElementById('summarizeLoader');
        const fetchText = document.getElementById('fetchText');
        const summarizeText = document.getElementById('summarizeText');
        const citationContainer = document.getElementById('citation-container');
        const sourcesList = document.getElementById('sources-list');

        let fullNewsText = ""; // Holds the full news content for summarization

        // --- Firebase Initialization (Mandatory Boilerplate) ---
        let db, auth;
        // setLogLevel('debug'); // Commented out to reduce console spam unless needed
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Sign in process
            if (authToken) {
                await signInWithCustomToken(auth, authToken);
            } else {
                await setPersistence(auth, browserSessionPersistence);
                await signInAnonymously(auth);
            }
            console.log("Firebase Auth initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
        // --------------------------------------------------------

        /**
         * Generic function to call the Netlify Proxy Function with exponential backoff.
         * @param {Object} body - The request body for the Netlify function.
         * @returns {Promise<Object|null>} The Gemini API result object, or null on failure.
         */
        async function callNetlifyFunction(body) {
            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(NETLIFY_FUNCTION_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Netlify Function error! status: ${response.status}, message: ${JSON.stringify(errorData)}`);
                    }

                    // Netlify function returns the raw Gemini result object in its body
                    const netlifyResult = await response.json(); 
                    
                    // Check if the Netlify function itself returned an error (e.g., if Gemini API failed)
                    if (netlifyResult.error) {
                         throw new Error(`Proxy error: ${netlifyResult.error}`);
                    }

                    const candidate = netlifyResult.candidates?.[0];
                    if (!candidate) {
                        throw new Error("API response candidates missing or empty.");
                    }
                    
                    // 1. Extract text
                    const text = candidate.content?.parts?.[0]?.text || '';

                    // 2. Extract grounding sources
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    return { text, sources };

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt < maxRetries - 1) {
                        const waitTime = Math.pow(2, attempt) * 1000;
                        console.log(`Retrying in ${waitTime}ms...`);
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }
            }
            return null; // Return null if all retries fail
        }

        /**
         * Fetches the top finance news stories using the Netlify proxy function.
         */
        async function fetchNews() {
            // UI state management
            fetchNewsBtn.disabled = true;
            summarizeBtn.disabled = true;
            initialMessage.classList.add('hidden');
            newsContentDiv.innerHTML = `<div class="text-center p-4">
                <div class="spinner border-4 border-gray-200 border-t-4 w-8 h-8 mx-auto"></div>
                <p class="mt-2 text-primary-blue">Fetching real-time financial headlines...</p>
            </div>`;
            newsContentDiv.classList.remove('hidden');
            citationContainer.classList.add('hidden');
            fetchLoader.classList.remove('hidden');
            fetchText.textContent = 'Fetching...';

            // Body payload for the Netlify function
            const body = { type: 'fetch' };

            const result = await callNetlifyFunction(body);

            // Restore UI state
            fetchNewsBtn.disabled = false;
            fetchLoader.classList.add('hidden');
            fetchText.textContent = "Get Today's Top News (Real-Time)";

            if (result && result.text) {
                fullNewsText = result.text;
                // Render Markdown to HTML and sanitize
                newsContentDiv.innerHTML = DOMPurify.sanitize(marked.parse(fullNewsText));
                summarizeBtn.disabled = false;
                
                // Display sources
                sourcesList.innerHTML = '';
                if (result.sources && result.sources.length > 0) {
                    result.sources.forEach(source => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-primary-blue hover:underline">${source.title}</a>`;
                        sourcesList.appendChild(li);
                    });
                    citationContainer.classList.remove('hidden');
                } else {
                    citationContainer.classList.add('hidden');
                }

            } else {
                newsContentDiv.innerHTML = `<p class="text-red-500 text-center">Failed to load news. Check Netlify logs for function error.</p>`;
                summarizeBtn.disabled = true;
            }
        }

        /**
         * Summarizes the existing full news content using the Netlify proxy function.
         */
        async function summarizeNews() {
            if (!fullNewsText) {
                newsContentDiv.innerHTML = `<p class="text-red-500 text-center">No news loaded to summarize.</p>`;
                return;
            }

            // UI state management
            fetchNewsBtn.disabled = true;
            summarizeBtn.disabled = true;
            summarizeLoader.classList.remove('hidden');
            summarizeText.textContent = 'Summarizing...';

            const originalContent = newsContentDiv.innerHTML; // Save original view

            // Display loading indicator in the content area
            newsContentDiv.innerHTML = `<div class="text-center p-4">
                <div class="spinner border-4 border-gray-200 border-t-4 w-8 h-8 mx-auto"></div>
                <p class="mt-2 text-primary-blue">Generating 60-word summary...</p>
            </div>`;
            citationContainer.classList.add('hidden'); // Hide sources for the summary

            // Body payload for the Netlify function (type is 'summarize' and includes the text)
            const body = { 
                type: 'summarize',
                textToSummarize: fullNewsText
            };

            const result = await callNetlifyFunction(body);

            // Restore UI state
            fetchNewsBtn.disabled = false;
            summarizeBtn.disabled = false;
            summarizeLoader.classList.add('hidden');
            summarizeText.textContent = "Summarize (60 Words Max)";


            if (result && result.text) {
                // Prepend the summary and provide a button to switch back
                const summaryHtml = `
                    <div class="bg-primary-blue text-white p-4 rounded-lg mb-4 shadow-md">
                        <h2 class="text-lg font-bold mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                            Market Snapshot (60-Word Summary)
                        </h2>
                        <p>${result.text}</p>
                    </div>
                    <button id="showFullNewsBtn" class="text-xs text-primary-blue hover:text-blue-700 font-semibold mt-2">
                        ‚Üê Show Full News
                    </button>
                    `;
                
                newsContentDiv.innerHTML = summaryHtml;
                
                // Add event listener to switch back to full news
                document.getElementById('showFullNewsBtn').addEventListener('click', () => {
                    newsContentDiv.innerHTML = originalContent;
                    citationContainer.classList.remove('hidden');
                });
            } else {
                // If summarization fails, restore original content and show error
                newsContentDiv.innerHTML = originalContent;
                newsContentDiv.innerHTML += `<p class="text-red-500 text-center mt-4">Failed to generate summary. Check Netlify logs for function error.</p>`;
            }
        }

        // --- Event Listeners ---
        fetchNewsBtn.addEventListener('click', fetchNews);
        summarizeBtn.addEventListener('click', summarizeNews);

    </script>
    <!-- Load necessary third-party libraries for markdown rendering and security -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>

</body>
</html>